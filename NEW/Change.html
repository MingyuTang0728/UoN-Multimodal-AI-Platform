<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multimodal AI Sharing Community – UK Co-Creation (No-bundler Proto)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; background: #070d12; }
    .glass { backdrop-filter: blur(8px); }
    .overlay { background: rgba(2,10,14,.72); }
    /* --- Sci-Fi panels; 去掉动态网格 --- */
    .holo-grid { position: relative; }
    .holo-grid::before{ content:""; position:absolute; inset:0; pointer-events:none; background:none; animation:none; opacity:0; }
    .holo-panel { position:relative; overflow:hidden; }
    .holo-panel::after{ content:""; position:absolute; inset:-1px; pointer-events:none; border-radius:12px;
      background: conic-gradient(from 180deg at 50% 50%, rgba(25,230,194,.18), rgba(7,13,18,0) 20%, rgba(25,230,194,.18) 40%, rgba(7,13,18,0) 60%, rgba(25,230,194,.18) 80%, rgba(7,13,18,0));
      filter: blur(8px); opacity:.8; mix-blend:screen;
    }
    .no-overflow { overflow:hidden; }
    .truncate-one { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  </style>
</head>
<body>
<div id="root" class="min-h-screen"></div>

<script type="module">
  import React, {useRef, useState, createContext} from 'https://esm.sh/react@18.3.1';
  import { createRoot } from 'https://esm.sh/react-dom@18.3.1/client';
  import htm from 'https://esm.sh/htm@3.1.1';

  import * as THREE from 'https://esm.sh/three@0.160.0';
  import { Canvas, useFrame, useThree } from 'https://esm.sh/@react-three/fiber@8.16.2?deps=react@18.3.1,react-dom@18.3.1,three@0.160.0';
  import { OrbitControls, Html, Billboard } from 'https://esm.sh/@react-three/drei@9.111.3?deps=react@18.3.1,react-dom@18.3.1,three@0.160.0,@react-three/fiber@8.16.2';
  import * as topojson from 'https://esm.sh/topojson-client@3.1.0';

  const html = htm.bind(React.createElement);
  const cn = (...a)=>a.filter(Boolean).join(' ');

  /* ----------------- Helpers ----------------- */
  async function openLocal(candidates){
    const base = new URL('./', window.location.href).href;
    for (const rel of candidates){
      const url = rel.startsWith('http') ? rel : (base + rel);
      try{ const r = await fetch(url, {method:'HEAD', cache:'no-store'}); if(r.ok){ window.location.href = url; return; } }catch(_){}
    }
    for (const rel of candidates){
      const url = rel.startsWith('http') ? rel : (base + rel);
      try{ const r = await fetch(url, {method:'GET', cache:'no-store'}); if(r.ok){ window.location.href = url; return; } }catch(_){}
    }
    alert('File not found. Put one of these next to this file:\n' + candidates.join('\n'));
  }

  /* ---------------- Error Boundary ---------------- */
  class Boundary extends React.Component {
    constructor(p){ super(p); this.state={err:null}; }
    static getDerivedStateFromError(err){ return {err}; }
    componentDidCatch(err, info){ console.error('Boundary caught:', err, info); }
    render(){
      if(this.state.err){
        return html`<div className="p-4 m-4 border border-red-800/60 bg-red-950/40 text-red-200 rounded">
          <div className="font-semibold">Runtime error</div>
          <pre className="whitespace-pre-wrap text-xs">${String(this.state.err?.stack||this.state.err?.message||this.state.err)}</pre>
        </div>`;
      }
      return this.props.children;
    }
  }

  /* ---------------- Tiny UI (pure SVG) ---------------- */
  const makeIcon = (children) => ({className=''}) => {
    const els = Array.isArray(children) ? children : [children];
    return html`<svg viewBox="0 0 24 24"
         className=${cn('inline-block align-middle', className)}
         fill="none" stroke="currentColor"
         strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">
      ${els.map((el, i) => React.cloneElement(el, { key: el?.key ?? ('k'+i) }))}
    </svg>`;
  };
  const Plus   = makeIcon(html`<path d="M12 5v14M5 12h14"/>`);
  const KeyI   = makeIcon(html`<circle cx="7.5" cy="12" r="3"/><path d="M10.5 12H19l-2 2 2 2"/>`);
  const LockI  = makeIcon(html`<rect x="5" y="11" width="14" height="8" rx="2"/><path d="M7 11V8a5 5 0 0 1 10 0v3"/>`);
  const UsersI = makeIcon(html`<path d="M16 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="3"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>`);
  const WandI  = makeIcon(html`<path d="M5 15L15 5"/><path d="M8 3v3M3 8h3M10.5 10.5l2.5 2.5M14 3v3M3 14h3"/>`);
  const StarI  = makeIcon(html`<path d="M12 17.5l-5.5 3 1-6-4.5-4 6.2-.9L12 3l2.8 6.6 6.2.9-4.5 4 1 6z"/>`);
  const ActivityI = makeIcon(html`<path d="M3 12h4l3 7 4-14 3 7h4"/>`);
  const DatabaseI = makeIcon(html`<ellipse cx="12" cy="5" rx="8" ry="3"/><path d="M4 5v6c0 1.66 3.58 3 8 3s8-1.34 8-3V5"/><path d="M4 11v6c0 1.66 3.58 3 8 3s8-1.34 8-3v-6"/>`);
  const ImageI = makeIcon(html`<rect x="3" y="5" width="18" height="14" rx="2"/><circle cx="8" cy="10" r="2"/><path d="M21 19l-7-7-4 4-3-3-4 4"/>`);
  const AudioI = makeIcon(html`<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 15v2a2 2 0 0 0 4 0v-2"/><path d="M9 15h4"/>`);
  const VideoI = makeIcon(html`<rect x="3" y="7" width="13" height="10" rx="2"/><path d="M16 9l5-2v10l-5-2z"/>`);
  const RouteI = makeIcon(html`<circle cx="6" cy="19" r="2"/><circle cx="18" cy="5" r="2"/><path d="M8 19h6a4 4 0 0 0 4-4V7"/>`);

  // 支持透传属性，便于加 id
  const Card = ({className='', children, ...props}) => html`<div ...${props} className=${cn('rounded-xl border border-teal-900/40 bg-[#0b131a] text-teal-100', className)}>${children}</div>`;
  const CardHeader = ({className='', children}) => html`<div className=${cn('p-4', className)}>${children}</div>`;
  const CardTitle = ({className='', children}) => html`<div className=${cn('font-semibold', className)}>${children}</div>`;
  const CardContent = ({className='', children}) => html`<div className=${cn('p-4 pt-0 text-sm text-teal-200/90', className)}>${children}</div>`;
  const Button = ({className='', variant='solid', onClick, children}) => html`<button onClick=${onClick} className=${cn('px-3 py-2 rounded-md text-sm transition', variant==='secondary' && 'bg-teal-900/40 hover:bg-teal-800/60 border border-teal-800 text-teal-100', variant==='outline' && 'border border-teal-800 text-teal-200 hover:bg-teal-900/30', variant==='solid' && 'bg-teal-500 hover:bg-teal-400 text-slate-900', className)}>${children}</button>`;
  const Input = ({className='', ...props}) => html`<input ...${props} className=${cn('w-full px-3 py-2 rounded-md bg-[#0a1016] border border-teal-900/60 text-teal-100 outline-none focus:border-teal-400', className)} />`;
  const Textarea = ({className='', ...props}) => html`<textarea ...${props} className=${cn('w-full px-3 py-2 rounded-md bg-[#0a1016] border border-teal-900/60 text-teal-100 outline-none focus:border-teal-400', className)} />`;
  const Badge = ({className='', children}) => html`<span className=${cn('px-2 py-0.5 rounded-md text-xs border border-teal-700/60 text-teal-300', className)}>${children}</span>`;

  const TabsCtx = createContext(null);
  const Tabs = ({value, onValueChange, children}) => html`<${TabsCtx.Provider} value=${{value, onValueChange}}>${children}<//>`;
  const TabsList = ({className='', children}) => html`<div className=${cn('inline-flex p-1 rounded-lg border border-teal-900/50 bg-[#0b131a]', className)}>${children}</div>`;
  const TabsTrigger = ({value, children}) => { const c=React.useContext(TabsCtx); const active=c?.value===value;
    return html`<button onClick=${()=>c?.onValueChange?.(value)} className=${cn('px-3 py-1.5 rounded-md text-sm', active?'bg-teal-900/50 text-teal-100':'text-teal-300 hover:text-teal-100')}>${children}</button>`;
  };
  const TabsContent = ({value, children, className=''}) => { const c=React.useContext(TabsCtx); return c?.value===value ? html`<div className=${className}>${children}</div>` : null; };

  /* ---------------- Data ---------------- */
  const initialUniversities = [
    { id:'nottingham', name:'University of Nottingham', city:'Nottingham', lat:52.94789458569521, lon:-1.184359334766157, color:'#00FFC6', url:'https://www.nottingham.ac.uk/' },
    { id:'ucl',        name:'UCL',                       city:'London',     lat:51.524777150336355, lon:-0.13464138691468552, color:'#7AE6FF', url:'https://www.ucl.ac.uk/' },
    { id:'kcl',        name:"King's College London",     city:'London',     lat:51.51176644044432,  lon:-0.11591852444269828, color:'#8AEAEA', url:'https://www.kcl.ac.uk/' },
    { id:'manchester', name:'University of Manchester',   city:'Manchester', lat:53.465800236849226, lon:-2.23263090101009,   color:'#7DF0FF', url:'https://www.manchester.ac.uk/' },
    { id:'sheffield',  name:'University of Sheffield',    city:'Sheffield',  lat:53.38145896551509,  lon:-1.4884014451934764, color:'#72F5B8', url:'https://www.sheffield.ac.uk/' },
    { id:'birmingham', name:'University of Birmingham',   city:'Birmingham', lat:52.45077233777155,  lon:-1.9305745029187473, color:'#67E4FF', url:'https://www.birmingham.ac.uk/' },
    { id:'edinburgh',  name:'University of Edinburgh',    city:'Edinburgh',  lat:55.944671983540886, lon:-3.189230573877079,  color:'#66FFE2', url:'https://www.ed.ac.uk/' },
    { id:'glasgow',    name:'University of Glasgow',      city:'Glasgow',    lat:55.87248722382082,  lon:-4.290012131552848, color:'#3DE7D2', url:'https://www.gla.ac.uk/' },
  ];

  const featuredProjects = [
    { id:'uk-flightpath', title:'UK Academic Flightpath', org:'UoN × UCL × Glasgow', tags:['Map','Timeline','WebGL'], stars:24, online:7, description:'A creative timeline overlay that animates inter-university collaboration routes by year; click a year to see regions glow and projects appear.', linkToList:null },
    { id:'ur-collab', title:'UR Robotic Arm Calibration', org:'UoN × UCL', tags:['Robotics','UR5e','RTDE'], stars:39, online:5, description:'Cross-lab calibration and replay for UR robots with CSV → kinematics → 3D rigs; multimodal data (video+IMU+force).',
      linkToList:['UR operation interface.html','UR%20operation%20interface.html','UR-operation-interface.html','ur-operation-interface.html'] },
    { id:'renewable-ai',  title:'Renewable Energy Systems',   org:'UCL × Manchester',        tags:['Energy','Time-series','Forecast'], stars:18, online:9, description:'Turbine sensor fusion and predictive maintenance using multimodal AI.' },
    { id:'ai-drug',       title:'AI Drug Discovery',          org:'Oxford × Cambridge',      tags:['BioAI','Molecule','Vision-Lang'], stars:51, online:12, description:'Vision-language models for protein-ligand binding with lab robots integration.' },
  ];

  const modalities = [
    { id:'text',  label:'Text/Docs',   icon:DatabaseI },
    { id:'image', label:'Images',      icon:ImageI },
    { id:'audio', label:'Audio',       icon:AudioI },
    { id:'video', label:'Video',       icon:VideoI },
    { id:'sensor',label:'Sensors/CSV', icon:ActivityI },
    { id:'3d',    label:'3D/GLB',      icon:RouteI },
  ];

  /* ---------------- Industrial Multimodal – Presets ---------------- */
  const PIPELINE_PRESETS = [
    {
      id:'vla_robotics',
      name:'VLA Robotics – Vision→Plan→UR5e',
      summary:'Use a VLA (e.g., OpenVLA/RT-2 family) to turn images + language goals into robot actions; export a UR5e CSV plan.',
      steps:['Ingest camera frame','Ground with language goal','Plan pick/place','Export UR5e CSV','Log & review'],
      modalities:['image','text','sensor','3D'],
      from:'UoN Robotics Lab',
      to:'UCL Co-Creation'
    },
    {
      id:'digital_shadow_sync',
      name:'Digital Shadow Sync – Shopfloor ↔ Cloud',
      summary:'Sync PLC/IoT telemetry into a Digital Shadow; run anomaly rules with an MLLM assistant; broadcast alerts to partner nodes.',
      steps:['Ingest PLC/CSV','Shadow update','MLLM summarize anomaly','Ticket & SLA','Audit trail'],
      modalities:['sensor','text','video'],
      from:'Glasgow Energy Systems',
      to:'Manchester Ops'
    },
    {
      id:'sensor_fusion_qc',
      name:'Sensor Fusion QC – Camera+LiDAR',
      summary:'Fuse camera + LiDAR for part localization / defect zones; share heatmaps to partner sites for validation.',
      steps:['Capture','Calibrate','Fuse & detect','Heatmap report','Publish to community'],
      modalities:['image','video','sensor'],
      from:'Imperial Vision Lab',
      to:'Oxford Methods'
    }
  ];

  /* ---------------- Industrial Widgets ---------------- */
  const Arrow = ({className=''}) => html`<svg viewBox="0 0 48 12" className=${className}><path d="M0 6h40" stroke="#19e6c2" strokeWidth="2"/><path d="M40 1l7 5-7 5" fill="#19e6c2"/></svg>`;

  const IndustrialPipelinesWidget = () => {
    const [sel,setSel]=React.useState(PIPELINE_PRESETS[0].id);
    const cur = PIPELINE_PRESETS.find(p=>p.id===sel)||PIPELINE_PRESETS[0];
    return html`<div className="space-y-3 text-sm">
      <div className="flex flex-wrap gap-2">
        ${PIPELINE_PRESETS.map(p=> html`<button key=${p.id} onClick=${()=>setSel(p.id)} className=${cn('px-2 py-1 rounded-md border text-xs', sel===p.id?'bg-teal-900/50 border-teal-500 text-teal-100':'border-teal-900/50 text-teal-300 hover:border-teal-700/60')}>${p.name}</button>`)}
      </div>
      <div className="rounded-lg border border-teal-900/50 p-3 bg-[#0a1016]">
        <div className="text-teal-100 font-medium mb-1">${cur.summary}</div>
        <div className="grid grid-cols-5 items-center gap-2">
          ${cur.steps.map((s,i)=> html`<div key=${'st'+i} className="col-span-1"><div className="rounded-md bg-[#0b131a] border border-teal-900/50 px-2 py-1 text-xs text-teal-200">${s}</div></div>${i<cur.steps.length-1 ? html`<${Arrow} key=${'ar'+i} className="w-full h-3"/>` : null}`)}
        </div>
        <div className="mt-2 flex items-center justify-between text-xs">
          <div className="flex flex-wrap gap-1">${cur.modalities.map(m=> html`<${Badge} key=${m}>${m.toUpperCase()}<//>`)}</div>
          <div className="flex items-center gap-2">From <span className="text-teal-200 font-medium">${cur.from}</span> → To <span className="text-teal-200 font-medium">${cur.to}</span></div>
        </div>
      </div>
    </div>`;
  };

  const OpsConsoleWidget = () => {
    const [q,setQ]=React.useState(1);
    const [ok,setOk]=React.useState(97.9);
    React.useEffect(()=>{
      const id=setInterval(()=>{ setQ(n=>Math.max(0, (n+(Math.random()<0.5?1:-1)))); setOk(o=> Math.min(99.5, Math.max(92, o + (Math.random()-0.5)))); },1800);
      return ()=>clearInterval(id);
    },[]);
    return html`<div className="grid grid-cols-3 gap-3 text-sm">
      <div className="rounded-lg border border-teal-900/50 p-3 bg-[#0a1016]"><div className="text-teal-300/70 text-xs">Queue</div><div className="text-2xl font-semibold">${q}</div></div>
      <div className="rounded-lg border border-teal-900/50 p-3 bg-[#0a1016]"><div className="text-teal-300/70 text-xs">Success Rate</div><div className="text-2xl font-semibold">${ok.toFixed(1)}%</div></div>
      <div className="rounded-lg border border-teal-900/50 p-3 bg-[#0a1016]"><div className="text-teal-300/70 text-xs">Last Run</div><div className="text-2xl font-semibold">${new Date().toLocaleTimeString()}</div></div>
      <div className="col-span-3 rounded-lg border border-teal-900/50 p-3 bg-[#0a1016] text-xs text-teal-200">Recent: VLA Robotics (UoN→UCL) • Digital Shadow Sync (Glasgow→Manchester) • Sensor Fusion QC (Imperial→Oxford)</div>
    </div>`;
  };

  // --- Community Task Broker (Edge↔Cloud, multimodal courier; local mock) ---
  const CommunityTaskBroker = () => {
    const templates = [
      {id:'inspection', name:'On-wing Inspection', steps:['Capture','Compress','Encrypt','Route','Acknowledge']},
      {id:'lab',        name:'Lab Robotics',       steps:['Record','Describe','Package','Dispatch','Confirm']},
      {id:'energy',     name:'Energy Telemetry',   steps:['Sample','Aggregate','Summarize','Alert','Archive']},
    ];
    const peers = ['Nottingham','UCL','Imperial','Manchester','Sheffield','Birmingham'];
    const [tpl,setTpl] = React.useState(templates[0].id);
    const [mods,setMods] = React.useState(new Set(['text','image','sensor']));
    const [selPeers,setSelPeers] = React.useState(new Set(['UCL','Imperial']));
    const [log,setLog] = React.useState('');
    const toggle=(S,v)=>{ const ns=new Set(S); ns.has(v)?ns.delete(v):ns.add(v); return ns; };
    const run=()=>{
      const t = templates.find(x=>x.id===tpl)||templates[0];
      const ms = Array.from(mods).sort().join(', ');
      const ps = Array.from(selPeers).join(' ↔ ');
      setLog(`Broker dispatch (mock)
Template: ${t.name}
Modalities: ${ms||'none'}
Peers: ${ps||'none'}
Steps: ${t.steps.join(' → ')}
Result: 2 tasks queued, 1 acknowledged.`);
    };
    return html`<div className="space-y-3 text-sm">
      <div className="flex flex-wrap items-center gap-2">
        <label className="text-xs text-teal-300/80">Template</label>
        <select value=${tpl} onChange=${e=>setTpl(e.target.value)} className="px-2 py-1 rounded-md bg-[#0a1016] border border-teal-900/60 text-teal-100 text-xs">
          ${templates.map(t=> html`<option key=${t.id} value=${t.id}>${t.name}</option>`)}
        </select>
        <div className="ml-auto flex items-center gap-2">
          <button onClick=${run} className="px-3 py-1.5 rounded-md bg-teal-500 text-slate-900 text-sm">Dispatch (mock)</button>
        </div>
      </div>
      <div className="grid grid-cols-2 gap-3">
        <div className="rounded-lg border border-teal-900/50 p-2 bg-[#0a1016]">
          <div className="text-xs text-teal-300/80 mb-1">Modalities</div>
          <div className="flex flex-wrap gap-1">
            ${['text','image','video','audio','sensor','3D'].map(m=> html`<button key=${m} onClick=${()=>setMods(s=>toggle(s,m))} className=${cn('px-2 py-0.5 rounded border text-xs', mods.has(m)?'bg-teal-900/50 border-teal-500 text-teal-100':'border-teal-800 text-teal-300')}>${m.toUpperCase()}</button>`)}
          </div>
        </div>
        <div className="rounded-lg border border-teal-900/50 p-2 bg-[#0a1016]">
          <div className="text-xs text-teal-300/80 mb-1">Peers</div>
          <div className="flex flex-wrap gap-1">
            ${peers.map(p=> html`<button key=${p} onClick=${()=>setSelPeers(s=>toggle(s,p))} className=${cn('px-2 py-0.5 rounded border text-xs', selPeers.has(p)?'bg-teal-900/50 border-teal-500 text-teal-100':'border-teal-800 text-teal-300')}>${p}</button>`)}
          </div>
        </div>
      </div>
      <div className="rounded-lg border border-teal-900/50 p-3 bg-[#0a1016]">
        <div className="text-teal-100 font-medium mb-1">Route Preview</div>
        <div className="grid grid-cols-5 items-center gap-2">
          ${(templates.find(x=>x.id===tpl)||templates[0]).steps.map((s,i)=> html`<div key=${'st'+i} className="col-span-1"><div className="rounded-md bg-[#0b131a] border border-teal-900/50 px-2 py-1 text-xs text-teal-200">${s}</div></div>${i<4? html`<svg key=${'ar'+i} viewBox="0 0 48 12" className="w-full h-3"><path d="M0 6h40" stroke="#19e6c2" strokeWidth="2"/><path d="M40 1l7 5-7 5" fill="#19e6c2"/></svg>`:null}`)}
        </div>
      </div>
      <pre className="whitespace-pre-wrap text-xs text-teal-200/90 bg-[#0a1016] border border-teal-900/60 rounded-md p-3 min-h-[72px]">${log||'Configure and click Dispatch to simulate cross-community courier.'}</pre>
    </div>`;
  };

  /* ---------------- Multimodal-AI Mock Tools (Lab) ---------------- */
  const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));
  const ChatLite = () => {
    const [model, setModel]   = React.useState('gpt-4.1');
    const [tools, setTools]   = React.useState({ web:true, code:false, vision:false });
    const [prompt, setPrompt] = React.useState('Explain a UK university collaboration idea that uses maps + robots.');
    const [out, setOut]       = React.useState('');
    const run = async ()=>{
      const badge = `[${model}${tools.web?' · web':''}${tools.code?' · code':''}${tools.vision?' · vision':''} · mock]`;
      const body  = `Sure — here is a concise plan:\n\n1) Map UI → select region and university.\n2) Connect datasets (image/video/CSV) and a robot cell.\n3) Use a multimodal model to summarize data, then generate a checklist.\n4) Export a small task plan for the UR5e player.\n\nThis panel is a *simulated* ChatGPT-style call; no network requests are made.`;
      setOut(`${badge}\n\n${body}`); await sleep(200);
    };
    const toggle = (k)=> setTools(t=> ({...t, [k]: !t[k]}));
    return html`<div className="space-y-2">
      <div className="flex items-center gap-2">
        <label className="text-xs text-teal-300/80">Model</label>
        <select value=${model} onChange=${e=>setModel(e.target.value)} className="px-2 py-1 rounded-md bg-[#0a1016] border border-teal-900/60 text-teal-100 text-xs">
          <option>gpt-4.1</option><option>gpt-4o-mini</option><option>llava-1.6</option><option>qwen-vl</option>
        </select>
        <div className="ml-2 flex items-center gap-2 text-xs">
          <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" checked=${tools.web}    onChange=${()=>toggle('web')} /> web</label>
          <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" checked=${tools.code}   onChange=${()=>toggle('code')} /> code</label>
          <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" checked=${tools.vision} onChange=${()=>toggle('vision')} /> vision</label>
        </div>
      </div>
      <textarea rows="4" className="w-full px-3 py-2 rounded-md bg-[#0a1016] border border-teal-900/60 text-teal-100 text-sm" value=${prompt} onChange=${e=>setPrompt(e.target.value)} />
      <div className="flex items-center justify-end gap-2">
        <button onClick=${run} className="px-3 py-1.5 rounded-md bg-teal-500 text-slate-900 text-sm">Run (mock)</button>
      </div>
      <pre className="whitespace-pre-wrap text-xs text-teal-200/90 bg-[#0a1016] border border-teal-900/60 rounded-md p-3 min-h-[88px]">${out||'Output will appear here...'}</pre>
    </div>`;
  };

  const VQALite = () => {
    const [imgURL, setImgURL] = React.useState('');
    const [q, setQ]           = React.useState('What is in this picture?');
    const [a, setA]           = React.useState('');
    const [box, setBox]       = React.useState(null);
    const onFile = (f)=>{ if(!f) return; const r=new FileReader(); r.onload=()=>setImgURL(r.result); r.readAsDataURL(f); setA(''); setBox(null); };
    const run = ()=>{
      const answer = q.toLowerCase().includes('how many') ? 'Approximately 3 (mock).' : 'It looks like buildings and roads — likely an urban scene (mock).';
      setA(answer + '\n\nNote: Vision result is simulated locally.');
      setBox({x:18, y:18, w:64, h:42});
    };
    return html`<div className="space-y-2">
      <div className="flex items-center justify-between gap-2">
        <input type="file" accept="image/*" onChange=${e=>onFile(e.target.files?.[0])} className="text-xs" />
        <button onClick=${run} className="px-3 py-1.5 rounded-md bg-teal-500 text-slate-900 text-sm">Ask (mock)</button>
      </div>
      <input className="w-full px-3 py-2 rounded-md bg-[#0a1016] border border-teal-900/60 text-teal-100 text-sm" value=${q} onChange=${e=>setQ(e.target.value)} />
      <div className="grid grid-cols-2 gap-2">
        <div className="relative aspect-[4/3] rounded-md border border-teal-900/60 bg-[#0a1016] overflow-hidden">
          ${imgURL ? html`<img src=${imgURL} className="absolute inset-0 w-full h-full object-contain"/>` : html`<div className="w-full h-full flex items-center justify-center text-xs text-teal-300/60">No image</div>`}
          ${box ? html`<div style=${{position:'absolute',left:box.x,top:box.y,width:box.w,height:box.h,border:'1.5px solid #3ef2d2',boxShadow:'0 0 0 9999px rgba(0,0,0,.25)'}}></div>`:null}
        </div>
        <pre className="whitespace-pre-wrap text-xs text-teal-200/90 bg-[#0a1016] border border-teal-900/60 rounded-md p-3 min-h-[110px]">${a||'Answer will appear here...'}</pre>
      </div>
    </div>`;
  };

  const ASRLite = () => {
    const [fname, setFname] = React.useState('');
    const [out, setOut]     = React.useState('');
    const run = ()=> setOut('This is a mock transcript. In a real setup, audio would be sent to Whisper/WhisperX and the text returned with timestamps.');
    return html`<div className="space-y-2">
      <div className="flex items-center justify-between gap-2">
        <input type="file" accept="audio/*" onChange=${e=> setFname(e.target.files?.[0]?.name||'')} className="text-xs" />
        <button onClick=${run} className="px-3 py-1.5 rounded-md bg-teal-500 text-slate-900 text-sm">Transcribe (mock)</button>
      </div>
      <div className="text-xs text-teal-300/70">${fname||'No file selected'}</div>
      <pre className="whitespace-pre-wrap text-xs text-teal-200/90 bg-[#0a1016] border border-teal-900/60 rounded-md p-3 min-h-[88px]">${out||'Transcript will appear here...'}</pre>
    </div>`;
  };

  const PDFQALite = () => {
    const [name, setName] = React.useState('');
    const [q, setQ]       = React.useState('Summarize the key points.');
    const [out, setOut]   = React.useState('');
    const run = ()=> setOut('Mock summary: Title, methods, results and conclusions detected. In production, an MLLM would ingest the PDF text and answer your question.');
    return html`<div className="space-y-2">
      <div className="flex items-center justify-between gap-2">
        <input type="file" accept="application/pdf" onChange=${e=>setName(e.target.files?.[0]?.name||'')} className="text-xs" />
        <button onClick=${run} className="px-3 py-1.5 rounded-md bg-teal-500 text-slate-900 text-sm">Ask PDF (mock)</button>
      </div>
      <div className="text-xs text-teal-300/70">${name||'No file selected'}</div>
      <input className="w-full px-3 py-2 rounded-md bg-[#0a1016] border border-teal-900/60 text-teal-100 text-sm" value=${q} onChange=${e=>setQ(e.target.value)} />
      <pre className="whitespace-pre-wrap text-xs text-teal-200/90 bg-[#0a1016] border border-teal-900/60 rounded-md p-3 min-h-[88px]">${out||'Answer will appear here...'}</pre>
    </div>`;
  };

  const RobotPlanLite = () => {
    const [goal, setGoal] = React.useState('Pick the blue cube from bin A and place it on the tray.');
    const [out, setOut]   = React.useState('');
    const run = ()=> setOut(`OpenVLA/RT-2 style plan (mock):\n\n1) Detect objects (camera feed).\n2) Localize blue cube; compute grasp pose.\n3) Move UR5e to pre-grasp → grasp → lift.\n4) Navigate to tray; place at target pose.\n5) Verify via vision and log to CSV.`);
    return html`<div className="space-y-2">
      <input className="w-full px-3 py-2 rounded-md bg-[#0a1016] border border-teal-900/60 text-teal-100 text-sm" value=${goal} onChange=${e=>setGoal(e.target.value)} />
      <div className="flex items-center justify-end gap-2">
        <button onClick=${run} className="px-3 py-1.5 rounded-md bg-teal-500 text-slate-900 text-sm">Plan (mock)</button>
      </div>
      <pre className="whitespace-pre-wrap text-xs text-teal-200/90 bg-[#0a1016] border border-teal-900/60 rounded-md p-3 min-h-[88px]">${out||'Plan will appear here...'}</pre>
    </div>`;
  };

  const MMLab = () => html`<div className="space-y-4">
    <div className="text-teal-300/80 text-xs">This is a <b>simulated</b> Multimodal-AI playground — no data leaves your browser.</div>
    <div className="grid xl:grid-cols-2 gap-4">
      <${Card} className="glass"><${CardHeader} className="pb-2"><${CardTitle} className="text-base">Chat • General Assistant<//><//><${CardContent}><${ChatLite}/><//></${Card}>
      <${Card} className="glass"><${CardHeader} className="pb-2"><${CardTitle} className="text-base">Vision Q&A (Image)<//><//><${CardContent}><${VQALite}/><//></${Card}>
      <${Card} className="glass"><${CardHeader} className="pb-2"><${CardTitle} className="text-base">Speech → Text (ASR)<//><//><${CardContent}><${ASRLite}/><//></${Card}>
      <${Card} className="glass"><${CardHeader} className="pb-2"><${CardTitle} className="text-base">PDF Q&A<//><//><${CardContent}><${PDFQALite}/><//></${Card}>
      <${Card} className="glass xl:col-span-2"><${CardHeader} className="pb-2"><${CardTitle} className="text-base">Robot Plan (VLA)<//><//><${CardContent}><${RobotPlanLite}/><//></${Card}>
    </div>
  </div>`;

  /* ---------------- Projection ---------------- */
  function llToXY(lat, lon) {
    // UK bbox roughly lon [-8, 2], lat [49, 59]
    const nx = (lon + 8) / 10;
    const ny = (lat - 49) / 10;
    const scaleX = 8.8, scaleY = 10.8;
    return [(nx - 0.5) * scaleX, (ny - 0.5) * scaleY];
  }

  /* ---------------- Optional: university markers (disabled) ---------------- */
  const SHOW_MARKERS = false;

  const UniMarker = ({uni, onActive, active}) => {
    const [x,y] = llToXY(uni.lat, uni.lon);
    const pulseRef = useRef();
    const groupRef = useRef();
    const { camera } = useThree();
    useFrame(({clock})=>{
      if(pulseRef.current){
        const s = 1 + Math.sin(clock.getElapsedTime()*2.4)*0.12;
        pulseRef.current.scale.setScalar(s);
      }
      if(groupRef.current && camera){
        const z = camera.position.z || 12;
        const size = 0.22 * (z/12);
        groupRef.current.scale.setScalar(size);
      }
    });
    return html`
      <group ref=${groupRef} position=${[x, y, 0]} onClick=${(e)=>{ e.stopPropagation(); onActive?.(uni); }}>
        <${Billboard} follow=${true}>
          <mesh ref=${pulseRef}>
            <sphereGeometry args=${[0.12, 24, 24]} />
            <meshStandardMaterial emissive=${uni.color} emissiveIntensity=${1.6} color="#0a0f14" transparent opacity=${active? 0: 1} />
          </mesh>
        </${Billboard}>
      </group>
    `;
  };

  /* ---------------- Camera ---------------- */
  const CameraRig = ({target, zoom=12, controls, offset=[0.6,0.15]}) => {
    const { camera } = useThree();
    const defPos = new THREE.Vector3(0, 0, 12);
    const defTar = new THREE.Vector3(offset[0], offset[1], 0);
    useFrame(()=>{
      const dest = target ? new THREE.Vector3(target[0]+offset[0], target[1]+offset[1], zoom) : defPos;
      camera.position.lerp(dest, 0.10);
      if(controls?.current){
        const t = target ? new THREE.Vector3(target[0]+offset[0], target[1]+offset[1], 0) : defTar;
        controls.current.target.lerp(t, 0.1);
        controls.current.update();
      }
    });
    return null;
  };

  const Ground = () => html`<mesh rotation-x=${-Math.PI/2} position=${[0,0,-0.03]}>
    <circleGeometry args=${[10.7,96]} />
    <meshStandardMaterial color="#0E1621" metalness=${0.2} roughness=${0.9} />
  </mesh>`;

  // ---- Embedded lite polygons fallback ----
  const FALLBACK_LITE = {
    type:'FeatureCollection',
    features:[
      { type:'Feature', properties:{ name:'England & Wales' }, geometry:{ type:'Polygon', coordinates:[[
        [-5.7,50.1],[1.8,50.9],[1.8,53.0],[-2.5,53.5],[-5.7,52.0],[-5.7,50.1]
      ]]}},
      { type:'Feature', properties:{ name:'Scotland' }, geometry:{ type:'Polygon', coordinates:[[
        [-7.5,54.5],[-0.5,54.5],[-0.5,58.7],[-6.5,58.7],[-7.5,54.5]
      ]]}},
      { type:'Feature', properties:{ name:'Northern Ireland' }, geometry:{ type:'Polygon', coordinates:[[
        [-8.2,54.0],[-5.3,54.0],[-5.3,55.2],[-8.2,55.2],[-8.2,54.0]
      ]]}}
    ]
  };

  /* ---------------- Regions (click to focus) ---------------- */
  const UKAdminRegions = ({highlightLL, activeRegionIndex=-1, onHighlightCenter, onHighlightBounds, onHighlightName, onRegionClick, universities=[]}) => {
    const [regions, setRegions] = useState([]);
    const [edges, setEdges] = useState([]);

    const inRing = (pt, ring) => {
      let inside = false;
      for(let i=0, j=ring.length-1; i<ring.length; j=i++){
        const xi=ring[i][0], yi=ring[i][1], xj=ring[j][0], yj=ring[j][1];
        const intersect = ((yi>pt[1]) !== (yj>pt[1])) && (pt[0] < (xj-xi)*(pt[1]-yi)/(yj-yi+1e-9) + xi);
        if(intersect) inside = !inside;
      }
      return inside;
    };
    const inPolygon = (pt, ringsXY) => {
      if(!ringsXY?.length) return false;
      const outer = ringsXY[0];
      if(!inRing(pt, outer)) return false;
      for(let h=1; h<ringsXY.length; h++){
        if(inRing(pt, ringsXY[h])) return false;
      }
      return true;
    };

    const pickName = (props={}) => props.name || props.NAME || props.lad19nm || props.LAD19NM || props.LAD20NM || props.LAD13NM || props.LAD15NM || Object.values(props).find(v=> typeof v==='string') || 'Unknown';

    React.useEffect(()=>{
      (async ()=>{
        const topoUrls = [
          'https://cdn.jsdelivr.net/gh/martinjc/UK-GeoJSON/json/administrative/gb/lad.topojson',
          'https://raw.githubusercontent.com/martinjc/UK-GeoJSON/master/json/administrative/gb/lad.topojson',
          'https://martinjc.github.io/UK-GeoJSON/json/administrative/gb/lad.topojson'
        ];
        const geoUrls  = [
          'https://cdn.jsdelivr.net/gh/martinjc/UK-GeoJSON/json/administrative/gb/lad.json',
          'https://raw.githubusercontent.com/martinjc/UK-GeoJSON/master/json/administrative/gb/lad.json',
          'https://martinjc.github.io/UK-GeoJSON/json/administrative/gb/lad.json'
        ];
        const localUrls = ['./lad.topojson','./lad.json','./data/lad.topojson','./data/lad.json'];

        let features = null;

        for (const u of topoUrls) {
          try {
            const r = await fetch(u, { cache:'no-store' });
            if (r.ok) {
              const t = await r.json();
              const key = Object.keys(t.objects)[0];
              features = topojson.feature(t, t.objects[key]).features;
              break;
            }
          } catch(_) {}
        }
        if (!features) {
          for (const u of geoUrls) {
            try {
              const r = await fetch(u, { cache:'no-store' });
              if (r.ok) { const g = await r.json(); features = g.features; break; }
            } catch(_) {}
          }
        }
        if (!features) {
          for (const u of localUrls) {
            try {
              const r = await fetch(new URL(u, window.location.href), { cache:'no-store' });
              if (r.ok) {
                const j = await r.json();
                if (j.type === 'Topology') {
                  const key = Object.keys(j.objects)[0];
                  features = topojson.feature(j, j.objects[key]).features;
                } else { features = j.features; }
                break;
              }
            } catch(_) {}
          }
        }
        if (!features) { console.warn('[UK map] fallback polygons.'); features = FALLBACK_LITE.features; }
        if(!features) return;

        const regs = [];
        const lineBuffers = [];

        for(const f of features){
          const geom = f.geometry;
          if(!geom) continue;
          const polys = (geom.type==='MultiPolygon') ? geom.coordinates : [geom.coordinates];

          for(const poly of polys){
            if(!poly || !poly.length) continue;

            const ringsXY = poly.map(ring => ring.map(([lon,lat])=> llToXY(lat,lon)));

            const outer = poly[0];
            const shape = new THREE.Shape();
            outer.forEach(([lon,lat],i)=>{ const [x,y]=llToXY(lat,lon); i? shape.lineTo(x,y): shape.moveTo(x,y); });
            for(let h=1; h<poly.length; h++){
              const ring = poly[h]; if(!ring?.length) continue;
              const hole = new THREE.Path();
              ring.forEach(([lon,lat],i)=>{ const [x,y]=llToXY(lat,lon); i? hole.lineTo(x,y): hole.moveTo(x,y); });
              shape.holes.push(hole);
            }
            const geomShape = new THREE.ShapeGeometry(shape, 2);

            const unisIn = (universities||[]).filter(u => {
              const pt = llToXY(u.lat, u.lon);
              const inRingLocal = (pt, ring) => {
                let ins=false;
                for(let a=0,b=ring.length-1;a<ring.length;b=a++){
                  const xi=ring[a][0], yi=ring[a][1], xj=ring[b][0], yj=ring[b][1];
                  const inter=((yi>pt[1])!==(yj>pt[1]))&&(pt[0] < (xj-xi)*(pt[1]-yi)/(yj-yi+1e-9) + xi);
                  if(inter) ins=!ins;
                }
                return ins;
              };
              if(!inRingLocal(pt, ringsXY[0])) return false;
              for(let h=1; h<ringsXY.length; h++){ if(inRingLocal(pt, ringsXY[h])) return false; }
              return true;
            });

            // centroid
            let area=0, cx=0, cy=0; const outerXY = ringsXY[0]||[];
            for(let i=0,j=outerXY.length-1;i<outerXY.length;j=i++){
              const x0=outerXY[j][0], y0=outerXY[j][1];
              const x1=outerXY[i][0], y1=outerXY[i][1];
              const a = x0*y1 - x1*y0; area += a; cx += (x0+x1)*a; cy += (y0+y1)*a;
            }
            area = area*0.5; if(Math.abs(area) < 1e-6){ cx = outerXY[0]?.[0]||0; cy = outerXY[0]?.[1]||0; } else { cx = cx/(6*area); cy = cy/(6*area); }

            regs.push({ geom: geomShape, ringsXY, name: pickName(f.properties||{}), unis: unisIn, center:[cx,cy] });

            for(const ring of poly){
              const arr = new Float32Array(ring.flatMap(([lon,lat])=>{ const [x,y]=llToXY(lat,lon); return [x,y,0]; }));
              lineBuffers.push(arr);
            }
          }
        }
        setRegions(regs);
        setEdges(lineBuffers);
      })();
    },[universities]);

    const highlightIndex = React.useMemo(()=>{
      if (typeof activeRegionIndex === 'number' && activeRegionIndex >= 0) return activeRegionIndex;
      if(!highlightLL || !regions.length) return -1;
      const ptXY = llToXY(highlightLL[0], highlightLL[1]);
      for(let i=0;i<regions.length;i++){
        if(inPolygon(ptXY, regions[i].ringsXY)) return i;
      }
      return -1;
    }, [activeRegionIndex, highlightLL, regions]);

    React.useEffect(()=>{
      const centerCb = typeof onHighlightCenter === 'function' ? onHighlightCenter : null;
      const boundsCb  = typeof onHighlightBounds  === 'function' ? onHighlightBounds  : null;
      if(highlightIndex < 0){
        centerCb && centerCb(null);
        boundsCb && boundsCb(null);
        if(typeof onHighlightName==='function') onHighlightName('');
        return;
      }
      const reg = regions[highlightIndex];
      const rings = reg?.ringsXY;
      if(!rings || !rings.length){
        centerCb && centerCb(null);
        boundsCb && boundsCb(null);
        if(typeof onHighlightName==='function') onHighlightName('');
        return;
      }
      const outer = rings[0];
      let area=0, cx=0, cy=0, minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
      for(let i=0, j=outer.length-1; i<outer.length; j=i++){
        const [x0,y0] = outer[j];
        const [x1,y1] = outer[i];
        const a = x0*y1 - x1*y0;
        area += a; cx += (x0+x1)*a; cy += (y0+y1)*a;
        if(x1<minX) minX=x1; if(y1<minY) minY=y1; if(x1>maxX) maxX=x1; if(y1>maxY) maxY=y1;
      }
      area = area*0.5;
      if(Math.abs(area) < 1e-6){
        centerCb && centerCb(null);
        boundsCb && boundsCb(null);
        if(typeof onHighlightName==='function') onHighlightName('');
        return;
      }
      cx = cx/(6*area); cy = cy/(6*area);
      centerCb && centerCb([cx,cy]);
      boundsCb && boundsCb([minX,minY,maxX,maxY]);
      if (typeof onHighlightName === 'function') onHighlightName(reg?.name||'');
    }, [highlightIndex, regions, onHighlightCenter, onHighlightBounds, onHighlightName]);

    const Beacon = ({pos=[0,0,0], color='#19e6c2'}) => {
      const beamRef = React.useRef();
      useFrame(({clock})=>{
        const t = clock.getElapsedTime();
        if(beamRef.current){
          const s = 0.94 + 0.06*Math.sin(t*2.8);
          beamRef.current.scale.set(1, s, 1);
          beamRef.current.material.opacity = 0.25 + 0.08*Math.sin(t*1.4);
        }
      });
      // 竖直短光束，从行政区中心“向上”发射（科幻感），不显示圆形涟漪
      return html`<group position=${[pos[0], pos[1], 0]}>
        <mesh ref=${beamRef} rotation-x=${Math.PI/2} position=${[0,0,0.55]}>
          <cylinderGeometry args=${[0.05,0.05,1.1,32,1,true]} />
          <meshBasicMaterial color=${color} transparent opacity=${0.24} blending=${THREE.AdditiveBlending} side=${THREE.DoubleSide} />
        </mesh>
      </group>`;
    };

{regions.map((r,i)=> html`
  <mesh key=${'f'+i} geometry=${r.geom}
        onClick=${(e)=>{ e.stopPropagation(); onRegionClick && onRegionClick({ index:i, name:r.name, center:r.center, unis:r.unis }); }}
        onPointerOver=${()=>{ document.body.style.cursor = 'pointer'; }}
        onPointerOut=${()=>{ document.body.style.cursor = 'default'; }}>
    ${(() => { const isActive = (i === highlightIndex); return html`<meshStandardMaterial
      color=${isActive ? '#10343a' : ((r.unis && r.unis.length>0) ? '#0b1520' : '#0b131a')}
      transparent
      opacity=${isActive ? 1.0 : ((r.unis && r.unis.length>0) ? 0.92 : 0.86)}
      emissive=${isActive ? '#19e6c2' : '#0bdcc7'}
      emissiveIntensity=${isActive ? 0.65 : ((r.unis && r.unis.length>0) ? 0.18 : 0.05)}
    />`; })()}
  </mesh>
`)}
      ${regions.filter(r=> (r.unis && r.unis.length>0) && r.center).map((r,i)=> html`<${Beacon} key=${'b'+i} pos=${r.center} />`)}
      ${edges.map((arr,i)=> html`
        <line key=${'l'+i}>
          <bufferGeometry>
            <bufferAttribute attach="attributes-position" array=${arr} count=${arr.length / 3} itemSize=${3} />
          </bufferGeometry>
          <lineBasicMaterial color="#00FFD1" transparent opacity=${0.9} />
        </line>
      `)}
    </group>`;
  };

  const USE_TERRAIN = false;

  /* ---------------- Scene ---------------- */
  const UKScene = ({universities, resetToken=0}) => {
    const controlsRef = useRef();
    const [focusCenter, setFocusCenter] = useState(null);
    const [focusBounds, setFocusBounds] = useState(null);
    const [activeRegion, setActiveRegion] = useState(null);

    React.useEffect(() => {
      setActiveRegion(null);
      setFocusCenter(null);
      setFocusBounds(null);
    }, [resetToken]);

    const { camera, size } = useThree();
    const vFov = (camera.fov || 45) * Math.PI/180;
    const hFov = 2 * Math.atan(Math.tan(vFov/2) * (size.width/size.height));
    const zoomForBounds = (b) => {
      if(!b) return 12;
      const w = b[2]-b[0], h = b[3]-b[1];
      const margin = 0.82;
      const zH = (h/(2*margin)) / Math.tan(vFov/2);
      const zW = (w/(2*margin)) / Math.tan(hFov/2);
      return Math.max(zH, zW);
    };

    const targetXY = focusCenter || null;
    const zFor = focusBounds ? zoomForBounds(focusBounds) : 12;
    const regSpan = focusBounds ? Math.max(focusBounds[2]-focusBounds[0], focusBounds[3]-focusBounds[1]) : 2;
    const labelFontPx = Math.max(12, Math.min(26, regSpan * 5.8));
    const dfLabel = Math.round(Math.max(12, zFor));
    const labelSize = Math.round(labelFontPx * 0.5);

    return html`<group position=${[0.6, 0.15, 0]}>
      <ambientLight intensity=${0.35} />
      <directionalLight position=${[4,5,6]} intensity=${0.7} />
      <mesh rotation-x=${-Math.PI/2} position=${[0,0,-0.03]}>
        <circleGeometry args=${[10.7,96]} />
        <meshStandardMaterial color="#0E1621" metalness=${0.2} roughness=${0.9} />
      </mesh>

      <${UKAdminRegions}
        highlightLL=${null}
        activeRegionIndex=${activeRegion ? activeRegion.index : -1}
        onHighlightCenter=${setFocusCenter}
        onHighlightBounds=${setFocusBounds}
        onHighlightName=${()=>{}}
        onRegionClick=${(payload)=>{ setActiveRegion(payload); }}
        universities=${universities}
      />

      ${SHOW_MARKERS ? universities.map(u=> html`<${UniMarker} key=${u.id} uni=${u} onActive=${()=>{}} active=${false} />`) : null}

      <${CameraRig} target=${targetXY} zoom=${zFor} controls=${controlsRef} offset=${activeRegion? [0,0] : [0.6,0.15]} />
      <${OrbitControls} ref=${controlsRef} enablePan=${false} enableRotate=${false} enableDamping=${true} dampingFactor=${0.14} zoomSpeed=${0.65} minDistance=${4} maxDistance=${30} />

      ${activeRegion ? (
        html`<${Html}
              position=${[ (targetXY?.[0]||0), (targetXY?.[1]||0) + ( (focusBounds ? (focusBounds[3]-focusBounds[1]) : 2) / 2 ) + 0.5, 0 ]}
              distanceFactor=${dfLabel}
              style=${{ pointerEvents:'none' }}>
              <div className="px-2.5 py-1.5 rounded bg-black/65 border border-teal-500/60 text-cyan-100 font-semibold"
                   style=${{ fontSize: labelSize + 'px', lineHeight: 1.05, whiteSpace:'nowrap', WebkitFontSmoothing:'auto', MozOsxFontSmoothing:'grayscale', transform:'translateZ(0)', filter:'none' }}>
                ${activeRegion.name}
              </div>
            </${Html}>`
      ) : null}

      ${(activeRegion && activeRegion.unis && activeRegion.unis.length) ? (
        html`<${Html}
              position=${[ (targetXY?.[0]||0) + ( (focusBounds ? (focusBounds[2]-focusBounds[0]) : 2) / 2 ) + 0.8, (targetXY?.[1]||0), 0 ]}
              distanceFactor=${Math.max(10, dfLabel)}
              style=${{ pointerEvents:'auto' }}>
              <div className="min-w-[260px] max-w-[320px] bg-black/55 border border-teal-700/50 rounded-xl px-3 py-2 text-sm">
                <div className="text-teal-100 font-semibold mb-2">${activeRegion.name}</div>
                <ul className="space-y-1">
                  ${activeRegion.unis.map(u => html`
                    <li key=${u.id} className="flex items-center justify-between gap-2">
                      <span className="text-teal-200">${u.name}</span>
                      ${u.url ? html`<a className="text-cyan-300 hover:underline" href=${u.url} target="_blank" rel="noopener">Open</a>` : null}
                    </li>
                  `)}
                </ul>
              </div>
            </${Html}>`
      ) : null}
    </group>`;
  };

  /* ---------------- Placeholder Charts ---------------- */
  const DonutWidget = () => html`<div className="h-48 flex items-center justify-center text-teal-300/80 text-sm">[Charts temporarily disabled]</div>`;

  /* ---------------- Views ---------------- */
  const ProjectCard = ({p,onOpen}) => html`<${Card} className="hover:border-teal-400/40 transition cursor-pointer" onClick=${()=>{ if(p.linkToList){ openLocal(p.linkToList); } else if(p.linkTo){ openLocal([p.linkTo]); } else { onOpen?.(p); } }}>
    <${CardHeader} className="pb-2">
      <div className="flex items-center justify-between">
        <${CardTitle} className="text-base">${p.title}<//>
        <div className="flex items-center gap-2 text-xs text-teal-300/70">${p.online} online</div>
      </div>
      <div className="text-xs text-teal-300/70">${p.org}</div>
    <//>
    <${CardContent}>
      <p className="mb-2">${p.description}</p>
      <div className="flex flex-wrap gap-1.5">
        ${p.tags.map(t=> html`<${Badge} key=${t}>${t}<//>` )}
      </div>
      <div className="flex items-center justify-between mt-4">
        <${Button} variant="secondary" onClick=${(e)=>{ e.stopPropagation(); if(p.linkToList){ openLocal(p.linkToList); } else if(p.linkTo){ openLocal([p.linkTo]); } else { onOpen?.(p); } }}>Open<//>
        <div className="text-xs text-teal-300/60 flex items-center gap-1"><${StarI} className="w-3.5 h-3.5" /> ${p.stars}</div>
      </div>
    <//>
  <//>`;

  const SpaceHeader = ({title, subtitle, icon:Icon}) =>
    html`<div className="flex items-center justify-between">
      <div>
        <div className="flex items-center gap-2 text-lg font-semibold"><${Icon} className="w-5 h-5" /> ${title}</div>
        <div className="text-teal-300/70 text-sm">${subtitle}</div>
      </div>
    </div>`;

  const CoCreationSpace = ({onOpenProject}) => html`<div className="grid lg:grid-cols-3 gap-4">
    ${featuredProjects.map(p=> html`<${ProjectCard} key=${p.id} p=${p} onOpen=${onOpenProject} />`)}
    <${Card} className="border-dashed">
      <${CardContent} className="h-full flex items-center justify-center p-8">
        <div className="text-center">
          <${WandI} className="mx-auto mb-3 h-6 w-6 text-teal-300" />
          <div className="text-teal-200">Bring your own project</div>
          <div className="text-sm text-teal-300/70">Drop datasets, choose modalities, invite collaborators</div>
        </div>
      <//>
    <//>
  </div>`;

  const PrivateSpace = ({authed}) => authed ? html`<div className="grid lg:grid-cols-3 gap-4">
    ${[1,2,3].map(i=> html`<${Card} key=${i}>
      <${CardHeader} className="pb-2"><${CardTitle} className="text-base">Private Project #${i}<//><//>
      <${CardContent} className="space-y-4">
        <div>Institution-only datasets and notes. Add members via email domain control.</div>
        <div className="grid grid-cols-3 gap-2">
          ${modalities.slice(0,3).map(m=> html`<div key=${m.id} className="flex items-center gap-1 text-xs text-teal-200">
            <${m.icon} className="h-3.5 w-3.5 text-teal-300" /> ${m.label}
          </div>` )}
        </div>
        <div className="flex items-center gap-2">
          <${Button} variant="secondary">Manage Access<//>
          <${Button} variant="outline">Open<//>
        </div>
      <//>
    <//>`)}
  </div>` : html`<div className="flex flex-col items-center justify-center rounded-2xl border border-teal-900/50 bg-[#0b131a] p-10 text-center">
    <${LockI} className="h-6 w-6 text-teal-300 mb-2" />
    <div className="text-teal-100 font-medium">Private Space is locked</div>
    <div className="text-sm text-teal-300/70">Use the API Key panel to verify your institution.</div>
  </div>`;

  /* ---------------- Header ---------------- */
  const Header = ({onCreate, onToggleSheet}) => html`<header className="w-full px-6 py-4 flex items-center justify-between border-b border-teal-900/40 bg-[#0a1016]/80 glass">
    <div className="flex items-center gap-3">
      <img src="MAI%20logo.png" alt="UK Open Multimodal AI Network" className="h-8 w-auto" />
      <div className="text-teal-100 font-semibold tracking-wide">MULTIMODAL AI SHARING COMMUNITY</div>
      <${Badge} className="ml-2">UK Co-Creation<//>
    </div>
    <div className="flex items-center gap-3">
      <${Button} variant="secondary" onClick=${onCreate}><span className="inline-flex items-center gap-1"><${Plus} className="w-4 h-4" /> New Project</span><//>
      <${Button} variant="outline" onClick=${onToggleSheet}><span className="inline-flex items-center gap-1"><${KeyI} className="w-4 h-4" /> Login with API Key</span><//>
    </div>
  </header>`;

  /* ---------------- 对齐工具：让右下卡片与左下卡片等高 ---------------- */
  const AlignHomeHeights = () => {
    React.useEffect(()=>{
      const sync=()=>{
        const L=document.getElementById('card-industrial');
        const R=document.getElementById('card-right-bottom');
        if(L&&R){ R.style.minHeight = L.offsetHeight + 'px'; }
      };
      sync();
      window.addEventListener('resize', sync);
      const obsL = new ResizeObserver(()=>sync());
      const obsR = new ResizeObserver(()=>sync());
      const L=document.getElementById('card-industrial');
      const R=document.getElementById('card-right-bottom');
      if(L) obsL.observe(L); if(R) obsR.observe(R);
      return ()=>{ window.removeEventListener('resize', sync); obsL.disconnect(); obsR.disconnect(); };
    },[]);
    return null;
  };

  /* ---------------- CSV/GLB Loader Dialog (默认隐藏) ---------------- */
  const Label = ({className='', children}) => html`<label className=${cn('text-sm text-teal-200', className)}>${children}</label>`;
  const Dialog = ({open, children}) => open ? html`${children}` : null;
  const DialogContent = ({className='', children}) => html`<div className="fixed inset-0 z-40 flex items-center justify-center"><div className="absolute inset-0 overlay"></div><div className=${cn('relative z-10 w-[620px] max-w-[95vw] rounded-xl border border-teal-900/40 bg-[#0b131a] p-4', className)}>${children}</div></div>`;
  const CreateProjectDialog = ({open, setOpen, onCreate}) => {
    const [title,setTitle] = useState('');
    const [desc,setDesc] = useState('');
    const [isPublic,setIsPublic] = useState(true);
    const [selected,setSelected] = useState(['text','image','sensor']);
    const toggle = (id)=> setSelected(s=> s.includes(id)? s.filter(x=>x!==id): [...s,id]);
    return html`${open ? html`
      <${Dialog}>
        <${DialogContent} className="sm:max-w-[620px]">
          <div className="pb-2"><div className="text-teal-100 text-lg font-semibold">Create Project</div></div>
          <div className="grid gap-4">
            <div className="grid gap-2">
              <${Label}>Title<//>
              <${Input} placeholder="e.g., UR Robotic Arm Calibration" value=${title} onChange=${e=>setTitle(e.target.value)} />
            </div>
            <div className="grid gap-2">
              <${Label}>Description<//>
              <${Textarea} placeholder="What do collaborators do here?" value=${desc} onChange=${e=>setDesc(e.target.value)} />
            </div>
            <div className="grid gap-2">
              <${Label}>Modalities<//>
              <div className="flex flex-wrap gap-2">
                ${modalities.map(m=> html`
                  <button key=${m.id} onClick=${()=>toggle(m.id)} className=${cn('flex items-center gap-2 px-3 py-2 rounded-xl border text-sm transition', selected.includes(m.id)?'bg-teal-900/40 border-teal-500/50 text-teal-100':'bg-transparent border-teal-900/50 text-teal-300 hover:border-teal-600/50')}>
                    <${m.icon} className="h-4 w-4" /> ${m.label}
                  </button>
                `)}
              </div>
            </div>
            <div className="flex items-center justify-end gap-2 pt-2">
              <${Button} variant="outline" onClick=${()=>setOpen(false)}>Cancel<//>
              <${Button} onClick=${()=>{ onCreate({title,desc,isPublic,modalities:selected}); setOpen(false); setTitle(''); setDesc(''); setSelected(['text','image','sensor']); }}>Create<//>
            </div>
          </div>
        <//>
      <//>` : null}`;
  };

  const DataLoaderDialog = ({open, setOpen}) => html`${open ? html`
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      <div className="absolute inset-0 overlay" onClick=${()=>setOpen(false)}></div>
      <div className="relative z-10 w-[520px] max-w-[95vw] rounded-xl border border-teal-900/40 bg-[#0b131a] p-5">
        <div className="text-teal-100 text-lg font-semibold mb-3">Load CSV & GLB</div>
        <div className="grid gap-3">
          <div>
            <${Label}>CSV (joints / telemetry)</${Label}>
            <input type="file" accept=".csv,.txt" className="mt-1 w-full text-sm text-teal-200" />
          </div>
          <div>
            <${Label}>GLB / GLTF (robot)</${Label}>
            <input type="file" accept=".glb,.gltf" className="mt-1 w-full text-sm text-teal-200" />
          </div>
        </div>
        <div className="mt-4 flex justify-end gap-2">
          <${Button} variant="outline" onClick=${()=>setOpen(false)}>Close</${Button}>
          <${Button} onClick=${()=>setOpen(false)}>Continue</${Button}>
        </div>
      </div>
    </div>
  `: null}`;

  /* ---------------- App ---------------- */
  function App(){
    const [universities] = useState(initialUniversities);
    const [apiKey, setApiKey] = useState('');
    const [authed, setAuthed] = useState(false);
    const [dialogOpen, setDialogOpen] = useState(false);
    const [apiSheetOpen, setApiSheetOpen] = useState(false);
    const [tab, setTab] = useState('home');
    const [openProject, setOpenProject] = useState(null);
    const [loaderOpen, setLoaderOpen] = useState(false);
    const [resetToken, setResetToken] = useState(0);

    React.useEffect(()=>{
      const onKey = (e)=>{ if(e.key === 'Escape') setTab('home'); };
      window.addEventListener('keydown', onKey);
      return ()=> window.removeEventListener('keydown', onKey);
    },[]);

    const onCreate = (payload) => {
      const item = { id:`p-${Math.random().toString(36).slice(2,7)}`, title: payload.title || 'Untitled',
        org:'Your Institution', tags: (payload.modalities||[]).map(m=>m.toUpperCase()), stars:0, online:1, description: payload.desc || '' };
      if(payload.isPublic){ featuredProjects.unshift(item); setTab('cocreation'); }
    };

    return html`<div className="min-h-screen w-full text-slate-100">
      <${Header} onCreate=${()=>setDialogOpen(true)} onToggleSheet=${()=>setApiSheetOpen(true)} />
      <main className="mx-auto max-w-[1440px] px-6 py-6">
        <${Tabs} value=${tab} onValueChange=${setTab}>
          <div className="flex items-center justify-between">
            <${TabsList}>
              <${TabsTrigger} value="home">Home<//>
              <${TabsTrigger} value="cocreation">Co-Creation Space<//>
              <${TabsTrigger} value="private">Private Space<//>
              <${TabsTrigger} value="lab">AI Lab<//>
            <//>
            <div className="text-xs text-teal-300/70">Prototype · 3D map + spaces · UK universities</div>
          </div>

          <!-- Home -->
          <${TabsContent} value="home" className="mt-4">
            <div className="relative h-[860px] rounded-2xl border border-teal-900/50 bg-[#0b131a] overflow-hidden">
              <${Canvas}
                className="w-full h-full"
                camera=${{ position:[0,0,12], fov:45 }}
                dpr=${Math.min(2, window.devicePixelRatio || 1)}
                gl=${{ powerPreference:'high-performance', antialias:true, alpha:true }}
                onPointerMissed=${() => setResetToken(t => t + 1)}
                onDoubleClick=${() => setResetToken(t => t + 1)}
                onContextMenu=${(e) => { e.preventDefault(); setResetToken(t => t + 1); }}
              >
                <${UKScene} universities=${universities} resetToken=${resetToken} />
              <//>
              <div className="absolute inset-x-0 bottom-2 flex justify-center z-10">
                <div className="text-[10px] text-teal-400/60 tracking-widest uppercase">Click a region to focus • ESC / Double-click to reset</div>
              </div>
            </div>

            <div className="mt-4 holo-grid p-2 rounded-xl">
              <div className="grid lg:grid-cols-2 gap-4">
                <!-- 左列 -->
                <div className="space-y-4 no-overflow">
                  <div className="w-full">
                    <${Card} className="glass holo-panel">
                      <${CardHeader} className="pb-2"><${CardTitle} className="text-base">Co-Creation Space Hub<//><//>
                      <${CardContent} className="space-y-3">
                        ${featuredProjects.slice(0,3).map(p=> html`
                          <div key=${p.id} className="text-sm p-2 rounded-lg border border-teal-900/50 hover:border-teal-700/60 transition ${(p.linkToList||p.linkTo)?'cursor-pointer':''} truncate-one"
                               onClick=${()=>{ if(p.linkToList){ openLocal(p.linkToList.map(x=> x)); } else if(p.linkTo){ openLocal([p.linkTo]); } }}
                               title=${(p.linkToList || p.linkTo) ? 'Open project' : ''}>
                            <div className="flex items-center justify-between"><div className="truncate-one">${p.title}</div><${Badge}>${p.online} online<//></div>
                            <div className="text-xs text-teal-300/70 truncate-one">${p.org}</div>
                          </div>
                        `)}
                        <${Button} variant="secondary" className="w-full">Explore All Feeds<//>
                      <//>
                    <//>
                  </div>

                  <div className="w-full">
                    <${Card} id="card-industrial" className="glass holo-panel">
                      <${CardHeader} className="pb-2"><${CardTitle} className="text-base">Industrial Multimodal Pipelines<//><//>
                      <${CardContent} className="no-overflow"><${IndustrialPipelinesWidget}/><//>
                    <//>
                  </div>
                </div>

                <!-- 右列 -->
                <div className="space-y-4 no-overflow">
                  <div className="w-full">
                    <${Card} className="glass holo-panel">
                      <${CardHeader} className="pb-2"><${CardTitle} className="text-base">Private Projects & Community<//><//>
                      <${CardContent} className="space-y-3 text-sm">
                        <div className="flex items-center gap-2"><${KeyI} className="w-4 h-4" /> Enter API Key for access</div>
                        <div className="space-y-1">
                          ${['Oxford','UCL','Imperial','Manchester'].map(u=> html`
                            <div key=${u} className="flex items-center justify-between text-xs border border-teal-900/50 rounded-md px-2 py-1">
                              <div className="text-teal-300/80 truncate-one">${u}</div><${Badge}>Unchecked<//>
                            </div>
                          `)}
                        </div>
                      <//>
                    <//>
                  </div>

                  <div className="w-full">
                    <${Card} className="glass holo-panel">
                      <${CardHeader} className="pb-2"><${CardTitle} className="text-base">Operations Console<//><//>
                      <${CardContent}><${OpsConsoleWidget}/><//>
                    <//>
                  </div>

                  <!-- 右下：全新模块 + 等高 -->
                  <div className="w-full">
                    <${Card} id="card-right-bottom" className="glass holo-panel">
                      <${CardHeader} className="pb-2"><${CardTitle} className="text-base">Community Task Broker (Mock)<//><//>
                      <${CardContent}><${CommunityTaskBroker}/><//>
                    <//>
                  </div>
                </div>
              </div>

              <!-- 挂载等高同步 -->
              <${AlignHomeHeights}/>
            </div>
          <//>

          <!-- Co-Creation -->
          <${TabsContent} value="cocreation" className="mt-4">
            <${SpaceHeader} title="Co-Creation Space" subtitle="Share projects openly with UK partners; fork, contribute, and align datasets. (UR project owned by University of Nottingham)" icon=${UsersI} />
            <div className="h-3"></div>
            <${CoCreationSpace} onOpenProject=${setOpenProject} />
          <//>

          <!-- Private -->
          <${TabsContent} value="private" className="mt-4">
            <${SpaceHeader} title="Private Space" subtitle="API-gated projects and institution-only datasets." icon=${LockI} />
            <div className="h-3"></div>
            <${PrivateSpace} authed=${authed} />
          <//>

          <!-- AI Lab -->
          <${TabsContent} value="lab" className="mt-4">
            <${SpaceHeader} title="Multimodal AI Lab (Industrial)" subtitle="Community graph, federated assets, paper-backed pipeline presets and ops console — holographic mock hub for cross-university collaboration." icon=${WandI} />
            <div className="h-3"></div>
            <div className="holo-grid p-2 rounded-xl">
              <div className="grid lg:grid-cols-2 gap-4">
                <${Card} className="glass holo-panel"><${CardHeader} className="pb-2"><${CardTitle} className="text-base">Chat • General Assistant<//><//><${CardContent}><${ChatLite}/><//></${Card}>
                <${Card} className="glass holo-panel"><${CardHeader} className="pb-2"><${CardTitle} className="text-base">Vision Q&A (Image)<//><//><${CardContent}><${VQALite}/><//></${Card}>
                <${Card} className="glass holo-panel"><${CardHeader} className="pb-2"><${CardTitle} className="text-base">Speech → Text (ASR)<//><//><${CardContent}><${ASRLite}/><//></${Card}>
                <${Card} className="glass holo-panel"><${CardHeader} className="pb-2"><${CardTitle} className="text-base">PDF Q&A<//><//><${CardContent}><${PDFQALite}/><//></${Card}>
                <${Card} className="glass holo-panel lg:col-span-2"><${CardHeader} className="pb-2"><${CardTitle} className="text-base">Robot Plan (VLA)<//><//><${CardContent}><${RobotPlanLite}/><//></${Card}>
              </div>
            </div>
          <//>
        <//>
      </main>

      <${DataLoaderDialog} open=${false} setOpen=${()=>{}} />
      <${CreateProjectDialog} open=${dialogOpen} setOpen=${setDialogOpen} onCreate=${onCreate} />

      ${openProject? html`<div className="fixed left-4 bottom-4 px-3 py-2 rounded-md border border-teal-800 bg-[#0b131a]">Project opened: ${openProject.title}</div>`: null}
      <div className="fixed right-4 bottom-4 opacity-80"><div className="w-6 h-6 rotate-45 bg-gradient-to-br from-teal-400/60 to-cyan-400/60 rounded-sm"></div></div>
    </div>`;
  }

  /* ---------------- Mount ---------------- */
  createRoot(document.getElementById('root')).render(html`<${Boundary}><${App}/></${Boundary}>`);
</script>
</body>
</html>